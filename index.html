<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Treasure Map</title>
<style>
  :root {
    --bg: #0b1220;
    --card-bg: #ffffff;
    --text: #0b1220;
    --muted: #667085;
    --accent: #007aff;
    --radius: 18px;
    --shadow: 0 10px 30px rgba(0,0,0,.12);
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    color: var(--text);
    line-height: 1.6;
    background: var(--bg);
    overflow-x: hidden;
  }
  /* Full-viewport pixel canvas */
  #pix {
    position: fixed; inset: 0; z-index: 0;
    width: 100vw; height: 100vh;
    image-rendering: pixelated; /* important! */
    display:block;
  }
  main { position: relative; z-index: 1; min-height: 100vh; display: grid; place-items: center; padding: 40px 20px; }
  .card {
    width: min(92vw, 480px);
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 22px 22px 24px;
    border: 1px solid rgba(0,0,0,.06);
  }
  h1, h2 { line-height: 1.25; margin: 0 0 10px; }
  h1 { font-size: 1.9rem; }
  h2 { font-size: 1.25rem; color: #11181c; }
  p { margin: 0 0 14px; color: #1f2937; }

  .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 10px; }
  label.visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

  input[type="text"], input[type="password"], input[type="tel"] {
    width: 100%; font-size: 1rem; padding: 12px 14px; border-radius: 12px; border: 1px solid #e5e7eb;
    outline: none; background: #fff; color: #111827;
  }
  input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent); }

  .btn {
    -webkit-tap-highlight-color: transparent;
    cursor: pointer; font-weight: 650; font-size: 1rem; padding: 12px 16px; border-radius: 12px; border: none; color: white;
    background: linear-gradient(180deg, #2ea4ff, #0a66ff); box-shadow: 0 6px 16px rgba(10,102,255,.25);
    transition: transform .05s ease, filter .15s ease, box-shadow .2s ease;
  }
  .btn:active { transform: translateY(1px) scale(0.99); }
  .btn:focus-visible { outline: 3px dotted #111; outline-offset: 2px; }
  .btn[disabled] { filter: grayscale(.35) brightness(.9); opacity: .7; cursor: not-allowed; box-shadow: none; }

  .hint { font-size: .95rem; color: #7a2e1b; background: #fff3e6; border: 1px dashed #ffb16b; border-radius: 10px; padding: 10px 12px; }

  nav { display:flex; gap: 8px; justify-content: center; margin-top: 12px; }
  nav a { color: #334155; text-decoration: none; font-size: .9rem; }

  section[hidden] { display:none; }

  /* Gate modal (uses <dialog>) */
  dialog { border: none; padding: 0; border-radius: 16px; box-shadow: var(--shadow); }
  dialog::backdrop { background: rgba(0,0,0,.55); backdrop-filter: blur(2px); }
  .modal { background: #fff; border-radius: 16px; width: min(92vw, 440px); padding: 18px 18px 20px; }
  .modal h3 { margin: 0 0 8px; font-size: 1.1rem; }
  .modal .row { grid-template-columns: 1fr auto; }
  .err { color: #b42318; font-size: .9rem; min-height: 1.1em; }

  /* Countdown */
  .time { font-variant-numeric: tabular-nums; font-size: clamp(2rem, 7vw, 3.75rem); font-weight: 750; letter-spacing: .5px; color: #0f172a; text-align: center; }

  /* Finale */
  #finale .inner { text-align: center; color: #fff; }
  #finale h1 { color: #fff; font-size: clamp(1.6rem, 4.6vw, 2.2rem); }
  .swans { display: flex; gap: 14px; align-items: center; justify-content: center; font-size: 42px; }
  .swan { display:inline-block; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35)); }
  .swan.mirror { transform: scaleX(-1); }

  /* Tiny footer helper */
  .meta { color: var(--muted); font-size: .85rem; text-align: center; margin-top: 8px; }

  /* --- minimal centering helpers --- */
  #countdown { text-align: center; }              /* centers heading + text on countdown */
  #finaleBtn { display: block; margin: 12px auto; } /* centers ‚ÄúRohan, are you ready?‚Äù */
  #showHint  { display: block; margin: 12px auto !important; } /* centers ‚ÄúView hint‚Äù on Clue 3 */
</style>
</head>

<body>
<canvas id="pix" aria-hidden="true"></canvas>
<main>
  <!-- HOME -->
  <section id="home" data-theme="home" class="card" role="region" aria-labelledby="home-title">
    <h1 id="home-title">Treasure Map</h1>
    <p>Welcome! Ready to begin the single-day treasure hunt?</p>
    <form id="startForm" class="row" onsubmit="event.preventDefault(); go('#clue1');">
      <span aria-hidden="true"></span>
      <button class="btn" type="submit">Start the hunt</button>
    </form>
    <nav aria-label="progress"><span class="meta">Home ‚Üí Clue 1 ‚Üí Gate ‚Üí Clue 2 ‚Üí Clue 3 ‚Üí Countdown ‚Üí Finale</span></nav>
  </section>

  <!-- CLUE 1 -->
  <section id="clue1" data-theme="clue1" class="card" role="region" aria-labelledby="c1-title" hidden>
    <h2 id="c1-title">Clue 1</h2>
    <p>‚ÄúOur favorite cafe with mini croissants. What‚Äôs its name?‚Äù</p>
    <form id="form1" class="row" autocomplete="off">
      <label for="a1" class="visually-hidden">Your answer</label>
      <input id="a1" name="a1" type="text" inputmode="text" placeholder="Type answer" required />
      <button id="s1" class="btn" type="submit" disabled>Submit</button>
    </form>
    <p id="msg1" class="meta" role="status" aria-live="polite"></p>
  </section>

  <!-- GATE (between Clue 1 and Clue 2) -->
  <dialog id="gate">
    <form id="gateForm" method="dialog" class="modal" autocomplete="off">
      <h3>Enter the 4-digit code</h3>
      <div class="row">
        <label class="visually-hidden" for="code">4-digit code</label>
        <input id="code" name="code" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="0000" maxlength="4" />
        <button id="gateBtn" class="btn" type="submit" disabled>Open</button>
      </div>
      <p id="gateErr" class="err" role="status" aria-live="polite"></p>
    </form>
  </dialog>

  <!-- CLUE 2 -->
  <section id="clue2" data-theme="clue2" class="card" role="region" aria-labelledby="c2-title" hidden>
    <h2 id="c2-title">Clue 2</h2>
    <p>‚ÄúThe first holy place we went, where you stole my glance for a lifetime.‚Äù</p>
    <form id="form2" class="row" autocomplete="off">
      <label for="a2" class="visually-hidden">Your answer</label>
      <input id="a2" name="a2" type="text" inputmode="text" placeholder="Type answer" required />
      <button id="s2" class="btn" type="submit" disabled>Submit</button>
    </form>
    <p id="msg2" class="meta" role="status" aria-live="polite"></p>
  </section>

  <!-- CLUE 3 -->
  <section id="clue3" data-theme="clue3" class="card" role="region" aria-labelledby="c3-title" hidden>
    <h2 id="c3-title">Clue 3</h2>
    <p>‚ÄúThis past roommate of mine has had a spicy love story in his life.‚Äù</p>
    <button class="btn" id="showHint" type="button" style="margin-top:10px;background:linear-gradient(180deg,#ff8a00,#fe5600);box-shadow:0 6px 16px rgba(227,82,0,.25);">View hint</button>
    <p id="hint" class="hint" hidden>he‚Äôs coming to our wedding.</p>

    <form id="form3" class="row" autocomplete="off">
      <label for="a3" class="visually-hidden">Your answer</label>
      <input id="a3" name="a3" type="text" inputmode="text" placeholder="Type answer" required />
      <button id="s3" class="btn" type="submit" disabled>Submit</button>
    </form>
    <p id="msg3" class="meta" role="status" aria-live="polite"></p>
  </section>

  <!-- COUNTDOWN -->
  <section id="countdown" data-theme="countdown" class="card" role="region" aria-labelledby="cd-title" hidden>
    <h2 id="cd-title">Countdown</h2>
    <p class="meta">Tick-tock‚Ä¶ the treasure awaits.</p>
    <div class="time" id="clock">13:00</div>
    <button id="finaleBtn" class="btn" type="button" hidden>Rohan, are you ready?</button>
  </section>

  <!-- FINALE -->
  <section id="finale" data-theme="finale" class="card" role="region" aria-labelledby="fin-title" hidden style="background:transparent;color:#fff;">
    <div class="inner">
      <h1 id="fin-title">You did it!</h1>
      <div class="swans">
        <span class="swan">ü¶¢</span>
        <span>‚ù§</span>
        <span class="swan mirror">ü¶¢</span>
      </div>
      <p class="meta" style="color:#e2e8f0">Forever starts now.</p>
    </div>
  </section>

  <p class="meta">¬© Rohan</p>
</main>

<script>
(() => {
  const $  = (s, el=document)=> el.querySelector(s);
  const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
  const normalize = (s) => (s || '').trim().toLowerCase().replace(/\s+/g,' ');
  const pix = document.getElementById('pix');
  const ctx = pix.getContext('2d');
  // --- Background images for specific screens (served from /assets on GitHub Pages) ---
  const BG_SOURCES = {
    clue1:     'assets/pixel-cafe.png',
    clue2:     'assets/pixel-gurdwara.png',
    clue3:     'assets/pixel-bangalore-map.png',
    countdown: 'assets/pixel-time.png'
  };
  const BG_IMAGES = {};
  for (const [key, src] of Object.entries(BG_SOURCES)) {
    const img = new Image();
    img.src = src;            // same origin when hosted on GitHub Pages
    BG_IMAGES[key] = img;
  }
  ctx.imageSmoothingEnabled = false;
  let activeTheme = 'home';
  // Adjustable countdown minutes via URL: ?m=1 sets 1 minute for testing
  const COUNT_MINUTES = Number(new URLSearchParams(location.search).get('m')) || 1;

  // --- Router ---
  const sections = $$('#home, #clue1, #clue2, #clue3, #countdown, #finale');
  function go(hash){
    if (typeof hash === 'string') location.hash = hash; else location.hash = '#home';
  }
  // expose for inline handler on the Start form
  window.go = go;
  function route(){
    const hash = location.hash || '#home';
    sections.forEach(s => s.hidden = true);
    const el = document.getElementById(hash.replace('#','')) || $('#home');
    el.hidden = false;
    activeTheme = el.getAttribute('data-theme') || 'home';
    drawActiveTheme();
  }
  window.addEventListener('hashchange', route);

  // --- Pixel painter ---
  function resizeCanvas(){
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    pix.width = Math.floor(pix.clientWidth * dpr);
    pix.height = Math.floor(pix.clientHeight * dpr);
    ctx.imageSmoothingEnabled = false;
  }
  function clear(){ ctx.clearRect(0,0,pix.width,pix.height); }

  function drawPixelBackground(theme){
    // Draw using 8x8 block tiles, tiled across viewport
    const w = pix.width, h = pix.height;

    // If a mapped background image exists for this theme, draw it scaled to cover
    const img = BG_IMAGES[theme];
    if (img) {
      if (img.complete && img.naturalWidth) {
        const scale = Math.max(w / img.naturalWidth, h / img.naturalHeight); // cover
        const dw = Math.ceil(img.naturalWidth * scale);
        const dh = Math.ceil(img.naturalHeight * scale);
        const dx = Math.floor((w - dw) / 2);
        const dy = Math.floor((h - dh) / 2);
        ctx.drawImage(img, dx, dy, dw, dh);
        return;
      } else {
        img.addEventListener('load', () => { drawActiveTheme(); }, { once: true });
      }
    }
    const px = 8 * Math.max(1, Math.floor(Math.min(w,h) / 320)); // scale pixel size a bit with screen
    const cols = Math.ceil(w / px), rows = Math.ceil(h / px);

    const palettes = {
      home: { base:'#F0D7A1', dot:'#B58956', accent:'#A84C2B' },
      clue1: { a:'#221c3a', b:'#2d2a68', c:'#ffb08a', d:'#ffd1a8' },
      clue2: { base:'#fff8e7', gold:'#d4a437', line:'#f1e4c6' },
      clue3: { a:'#ffefe6', b:'#ffcfb3', c:'#ff8a5b', d:'#ff653a' },
      countdown: { sky:'#0d1530', star1:'#f8f9fb', star2:'#cde2ff' },
      finale: { sky:'#070913', dim:'#0f1630' }
    };

    // helpers
    function fill(x,y,color){
      ctx.fillStyle = color;
      const xx = x*px, yy = y*px;
      ctx.fillRect(xx,yy,px,px);
    }

    if(theme === 'home'){
      // subtle parchment dots
      ctx.fillStyle = palettes.home.base; ctx.fillRect(0,0,w,h);
      for (let y=0; y<rows; y++){
        for (let x=0; x<cols; x++){
          if(Math.random()<0.08) fill(x,y, palettes.home.dot);
        }
      }
      return;
    }

    if(theme === 'clue1'){
      // warm dusk gradient with sparkles
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,palettes.clue1.a);
      g.addColorStop(1,palettes.clue1.b);
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
      for(let i=0; i<Math.floor(cols*rows*0.02); i++){
        const rx = Math.floor(Math.random()*cols);
        const ry = Math.floor(Math.random()*rows);
        fill(rx,ry, Math.random()<0.5?palettes.clue1.c:palettes.clue1.d);
      }
      return;
    }

    if(theme === 'clue2'){
      // map-paper vibe
      ctx.fillStyle = palettes.clue2.base; ctx.fillRect(0,0,w,h);
      for(let y=0; y<rows; y++){
        for(let x=0; x<cols; x++){
          if((x+y)%7===0) fill(x,y,palettes.clue2.line);
          if(Math.random()<0.02) fill(x,y,palettes.clue2.gold);
        }
      }
      return;
    }

    if(theme === 'clue3'){
      // playful warm checker noise
      for(let y=0; y<rows; y++){
        for(let x=0; x<cols; x++){
          const r = (x^y)%4;
          const c = [palettes.clue3.a, palettes.clue3.b, palettes.clue3.c, palettes.clue3.d][r];
          fill(x,y,c);
        }
      }
      return;
    }

    if(theme === 'countdown'){
      ctx.fillStyle = palettes.countdown.sky; ctx.fillRect(0,0,w,h);
      for(let i=0;i<Math.floor((cols+rows)*0.9);i++){
        const sx = Math.floor(Math.random()*cols), sy = Math.floor(Math.random()*rows);
        fill(sx,sy, Math.random()<0.6?palettes.countdown.star1:palettes.countdown.star2);
      }
      return;
    }

    if(theme === 'finale'){
      // dark sky base; animated fireworks handled elsewhere
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,palettes.finale.dim);
      g.addColorStop(1,palettes.finale.sky);
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
      // sparse stars
      const cols2 = Math.ceil(cols/2), rows2 = Math.ceil(rows/2);
      for(let i=0;i<cols2;i++){
        const sx = Math.floor(Math.random()*cols), sy = Math.floor(Math.random()*rows);
        fill(sx,sy, '#8fb9ff');
      }
      return;
    }
  }

  function drawActiveTheme(){
    resizeCanvas(); clear(); drawPixelBackground(activeTheme);
  }
  window.addEventListener('resize', () => { drawActiveTheme(); });

  // Simple fireworks for finale
  const particles = [];
  const mouse = { x: ()=> window.innerWidth/2, y: ()=> window.innerHeight/2 };
  const w = ()=> pix.width, h = ()=> pix.height;
  let rafId = null;
  function startFireworks(){
    if(rafId) return;
    const px = 6 * Math.max(1, Math.floor(Math.min(w(),h()) / 400));

    function burst(cx, cy){
      const colors = ['#ffd166','#fca311','#ff4d6d','#60d2ff','#8cff6f','#b084ff'];
      const N = 60 + Math.floor(Math.random()*40);
      for(let i=0;i<N;i++){
        const ang = (i/N) * Math.PI*2 + (Math.random()*0.3);
        const spd = (0.8 + Math.random()*2.2) * px;
        particles.push({
          x: cx, y: cy,
          vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd,
          life: 60 + Math.random()*30, age: 0,
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
    }
    function step(){
      rafId = requestAnimationFrame(step);
      clear();
      drawPixelBackground('finale');
      ctx.globalCompositeOperation = 'lighter';
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.age++;
        p.x += p.vx*0.016; p.y += p.vy*0.016;
        p.vy += 0.01 * px;
        const t = 1 - (p.age/p.life);
        ctx.globalAlpha = Math.max(0, t);
        ctx.fillStyle = p.color;
        ctx.fillRect(Math.floor(p.x), Math.floor(p.y), Math.max(1, Math.floor(px/3)), Math.max(1, Math.floor(px/3)));
        if(p.age>=p.life) particles.splice(i,1);
      }
      ctx.globalAlpha = 1; ctx.globalCompositeOperation = 'source-over';
      if(Math.random() < 0.03) burst(Math.random()*w(), Math.random()*h()*0.8 + h()*0.1);
    }
    step();
  }

  // Forms wiring helpers
  function wireForm(formId, inputId, submitId, expectedAnswer, onPass){
    const form = document.getElementById(formId);
    const input = document.getElementById(inputId);
    const submit = document.getElementById(submitId);

    input.addEventListener('input', ()=>{
      const v = normalize(input.value);
      submit.disabled = (v.length < 2);
    });

    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const ans = normalize(input.value);
      const expected = normalize(expectedAnswer);
      if(ans === expected){ onPass(); }
      else { const msg = form.nextElementSibling; if(msg) msg.textContent = 'Not quite ‚Äì try again.'; input.focus(); }
    });
  }

  // CLUE 1 ‚Üí open Gate modal
  wireForm('form1','a1','s1','xero degrees', ()=>{
    $('#msg1').textContent = 'Correct!';
    const d = document.getElementById('gate');
    try { d.showModal(); } catch(e){ d.setAttribute('open',''); }
    const code = $('#code'); const btn = $('#gateBtn'); const err = $('#gateErr');
    const update = ()=> btn.disabled = !/^\d{4}$/.test(code.value);
    code.value=''; err.textContent=''; update(); code.focus();
    d.addEventListener('close', ()=>{ /* noop */ });
    // Use .onsubmit to avoid stacking multiple listeners
    document.getElementById('gateForm').onsubmit = (ev)=>{
      ev.preventDefault();
      const v = code.value.replace(/\D/g,'');
      if(v === '1256'){
        err.textContent=''; try{ d.close(); }catch(_){ d.removeAttribute('open'); }
        go('#clue2');
      } else {
        err.textContent = 'Wrong code. (Hint: talk to Rohan!)';
      }
    };
    code.addEventListener('input', update);
  });

  // CLUE 2 ‚Üí proceed
  wireForm('form2','a2','s2','bangla sahib', ()=>{ $('#msg2').textContent='Correct!'; go('#clue3'); });

  // CLUE 3 ‚Üí proceed
  document.getElementById('showHint').addEventListener('click', ()=>{
    document.getElementById('hint').hidden = false;
  });
  wireForm('form3','a3','s3','akshay', ()=>{ $('#msg3').textContent='Correct!'; go('#countdown'); startClock(); });

  // Countdown logic
  const CLOCK = document.getElementById('clock');
  const FINALE_BTN = document.getElementById('finaleBtn');
  let countdownTimer = null;
  function startClock(){
    let t = Math.max(1, COUNT_MINUTES) * 60; // seconds
    FINALE_BTN.hidden = true;
    update();
    countdownTimer = setInterval(()=>{
      t--; update();
      if(t<=0){ clearInterval(countdownTimer); FINALE_BTN.hidden = false; CLOCK.textContent = '00:00'; }
    }, 1000);
    function update(){
      const m = Math.floor(t/60).toString().padStart(2,'0');
      const s = Math.floor(t%60).toString().padStart(2,'0');
      CLOCK.textContent = `${m}:${s}`;
    }
  }

  function resetApp(){
    // force start at Clue 1 without adding a history entry
    history.replaceState(null, '', '#clue1');
  }

  // Finale button
  FINALE_BTN.addEventListener('click', ()=>{ go('#finale'); startFireworks(); });

  // Kick off first route & background (fresh every reload)
  resetApp();
  route();
})();
</script>
</body>
</html>
